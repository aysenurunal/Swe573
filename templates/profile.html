{% extends "base.html" %}
{% block title %}{{ user.email.split("@")[0] }} — Profile{% endblock %}
{% block content %}

{% if session.get("user_id") == user.user_id %}
  <p><b>Email:</b> {{ user.email }}</p>
{% endif %}

<p><strong>Timebank Balance:</strong> {{ user.timebank_balance }} hours</p>

{% if session.get("user_id") and session.get("user_id") != user.user_id %}
  <div style="display:flex; gap:12px; align-items:center; margin:12px 0; flex-wrap:wrap;">
    <form action="{{ url_for('toggle_block', user_id=user.user_id) }}" method="POST">
      <button type="submit" style="padding:8px 12px; border:none; border-radius:8px; cursor:pointer; background:#0ea5e9; color:white; font-weight:700;">
        {{ 'Unblock user' if is_blocking else 'Block user' }}
      </button>
    </form>
    <a href="{{ url_for('report_user', user_id=user.user_id) }}" style="padding:8px 12px; background:#f97316; color:white; border-radius:8px; text-decoration:none; font-weight:700;">Report to admin</a>

    {% if admin_viewer and not user.is_admin %}
      <form action="{{ url_for('ban_user', user_id=user.user_id) }}" method="POST" style="margin:0;">
        <button type="submit" style="padding:8px 12px; border:none; border-radius:8px; cursor:pointer; background:#ef4444; color:white; font-weight:700;">Ban user</button>
      </form>
      {% if user.is_banned %}
        <form action="{{ url_for('unban_user', user_id=user.user_id) }}" method="POST" style="margin:0;">
          <button type="submit" style="padding:8px 12px; border:none; border-radius:8px; cursor:pointer; background:#22c55e; color:white; font-weight:700;">Unban user</button>
        </form>
      {% endif %}
    {% endif %}
  </div>
{% endif %}

{% if user.is_banned %}
  <p style="color:#ef4444; font-weight:700;">This user is banned.</p>
{% endif %}

{% if session.get("user_id") == user.user_id %}
  <a href="{{ url_for('logout') }}" style="color:#f43f5e; font-weight:600;">Logout</a>
{% endif %}

<!-- ---------------- TAB BUTTONS ---------------- -->
<div class="tab-buttons">
  <button class="tab-btn active" onclick="showTab('active')">ACTIVE POSTS</button>
  <button class="tab-btn" onclick="showTab('completed')">COMPLETED POSTS</button>
  <button class="tab-btn" onclick="showTab('comments')">COMMENTS</button>
</div>

<hr>

<!-- ---------------- ACTIVE POSTS TAB ---------------- -->
<div id="tab-active" class="tab-content">

  <h3>Active Offers</h3>
  {% if active_offers %}
    {% for offer in active_offers %}
      <a href="{{ url_for('offer_detail', offer_id=offer.offer_id) }}" class="post-card">
        <div class="post-title">{{ offer.title }}</div>
        <div class="post-meta">
          {{ offer.hours }} hours — {{ offer.location }}
          {% if offer.posted_at %} — {{ offer.posted_at.strftime('%d.%m.%Y') }}{% endif %}
        </div>
      </a>
    {% endfor %}
  {% else %}
    <p>No active offers.</p>
  {% endif %}

  <h3 style="margin-top:25px;">Active Needs</h3>
  {% if active_needs %}
    {% for need in active_needs %}
      <a href="{{ url_for('need_detail', need_id=need.need_id) }}" class="post-card">
        <div class="post-title">{{ need.title }}</div>
        <div class="post-meta">
          {{ need.hours }} hours — {{ need.location }}
          {% if need.posted_at %} — {{ need.posted_at.strftime('%d.%m.%Y') }}{% endif %}
        </div>
      </a>  {# ✅ EKSİK OLAN KAPANIŞ BUYDU #}
    {% endfor %}
  {% else %}
    <p>No active needs.</p>
  {% endif %}

</div>

<!-- ---------------- COMPLETED POSTS TAB ---------------- -->
<div id="tab-completed" class="tab-content" style="display:none;">

  <h3>Completed Offers</h3>
  {% if completed_offers %}
    {% for offer in completed_offers %}
      <div class="post-card completed">
        <div class="post-title">{{ offer.title }}</div>
        <div class="post-meta">
          {{ offer.hours }} hours — {{ offer.location }}
          {% if offer.posted_at %} — {{ offer.posted_at.strftime('%d.%m.%Y') }}{% endif %}
        </div>
          {% set key = 'offer:' ~ offer.offer_id %}
        {% if listing_comments.get(key) %}
          {% for comment in listing_comments[key] %}
            <div class="comment-bubble">
              <div class="comment-meta">From {{ comment.from_email|mask_email }} — on {{ comment.created_at.strftime('%d.%m.%Y') }}</div>
              <div class="comment-text">“{{ comment.content }}”</div>
            </div>
          {% endfor %}
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p>No completed offers.</p>
  {% endif %}

  <h3 style="margin-top:25px;">Completed Needs</h3>
  {% if completed_needs %}
    {% for need in completed_needs %}
      <div class="post-card completed">
        <div class="post-title">{{ need.title }}</div>
        <div class="post-meta">
          {{ need.hours }} hours — {{ need.location }}
          {% if need.posted_at %} — {{ need.posted_at.strftime('%d.%m.%Y') }}{% endif %}
        </div>
          {% set key = 'need:' ~ need.need_id %}
        {% if listing_comments.get(key) %}
          {% for comment in listing_comments[key] %}
            <div class="comment-bubble">
              <div class="comment-meta">From: {{ comment.from_email }} — on {{ comment.created_at.strftime('%d.%m.%Y') }}</div>
              <div class="comment-text">“{{ comment.content }}”</div>
            </div>
          {% endfor %}
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p>No completed needs.</p>
  {% endif %}

</div>

<!-- ---------------- COMMENTS TAB ---------------- -->
<div id="tab-comments" class="tab-content" style="display:none;">
  <h3>Feedback Received</h3>
  {% if comments %}
    {% for comment in comments %}
      <div class="comment-card">
        <div class="comment-header">
          <span class="comment-author">From {{ comment.from_email|mask_email }}</span>
          <span class="comment-date">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
        </div>
        <div class="comment-body">{{ comment.content }}</div>
        <div class="comment-footer">Related to: {{ comment.listing_title }}</div>
      </div>
    {% endfor %}
  {% else %}
    <p>No comments yet.</p>
  {% endif %}
</div>

<!-- -------------- CSS -------------- -->
<style>
.tab-buttons {
  display:flex;
  justify-content:center;
  gap:40px;
  margin-bottom:10px;
}

.tab-btn {
  background:none;
  border:none;
  font-size:15px;
  font-weight:600;
  padding:8px 16px;
  cursor:pointer;
  color:#555;
  border-bottom:2px solid transparent;
}

.tab-btn.active {
  color:#facc15;
  border-bottom-color:#facc15;
}

.post-card {
  display:block;
  background:#111827;
  padding:16px;
  border-radius:12px;
  margin:12px 0;
  text-decoration:none;
  color:white;
}

.post-card.completed {
  background:#1f2937;
  opacity:0.8;
}
.comment-bubble {
  background:#0f172a;
  border-left:4px solid #38bdf8;
  padding:10px;
  border-radius:8px;
  margin-top:8px;
}

.comment-meta { font-size:12px; color:#9ca3af; margin-bottom:4px; }
.comment-text { font-size:14px; color:#e5e7eb; }

.comment-card {
  background:#0f172a;
  padding:14px;
  border-radius:10px;
  margin:12px 0;
  border:1px solid #1f2937;
}

.comment-header {
  display:flex;
  justify-content:space-between;
  font-size:13px;
  color:#9ca3af;
  margin-bottom:6px;
}

.comment-body { font-size:15px; color:#f8fafc; margin-bottom:6px; }
.comment-footer { font-size:12px; color:#cbd5e1; }
.post-title {
  font-size:18px;
  font-weight:600;
  color:#facc15;
}

.post-meta {
  font-size:14px;
  opacity:0.8;
  margin-top:4px;
}
</style>

<!-- -------------- JAVASCRIPT TABS -------------- -->
<script>
function showTab(tab) {
  // Hide all
  ["tab-active", "tab-completed", "tab-comments"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
  });
  // Remove active class
  document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));

  // Show selected
  const tabMap = {
    "active": 0,
    "completed": 1,
    "comments": 2
  };

  const target = document.getElementById(`tab-${tab}`);
  if (target) target.style.display = "block";

  const index = tabMap[tab];
  if (index !== undefined) {
    const btn = document.querySelectorAll(".tab-btn")[index];
    if (btn) btn.classList.add("active");
  }
}
</script>

{% endblock %}
