{% extends 'base.html' %}
{% block title %}Community Forum | The Hive{% endblock %}
{% block content %}

<div class="forum-page">
  <section class="forum-hero">
    <h1>Community Forum</h1>
    <p>Share your ideas, ask for help, and connect with your neighbors.</p>
  </section>

  <section class="new-post-card">
    <h2>Latest discussions</h2>
    {% if session.get('user_id') %}
      <form action="{{ url_for('create_forum_post') }}" method="post" class="form-grid">
        <label for="title">Title</label>
        <input id="title" name="title" type="text" required>

        <label for="content">Content</label>
        <textarea id="content" name="content" rows="3" required></textarea>

        <button type="submit" class="btn-primary">Start thread</button>
      </form>
    {% else %}
      <p class="muted-text">Please <a href="{{ url_for('login') }}">sign in</a> to start a new discussion.</p>
    {% endif %}
  </section>

  {% for post in posts %}
    <article class="post-card">
      <div class="post-title">
        <a href="{{ url_for('view_profile', user_id=post.author.user_id) }}">{{ post.title }}</a>
      </div>

      <div class="post-meta">
        <span>
          Posted by
          <a class="profile-link" href="{{ url_for('view_profile', user_id=post.author.user_id) }}">
            {{ post.author.email }}
          </a>
        </span>
        <span>{{ post.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
      </div>

      <p>{{ post.content }}</p>

      {% if session.get('user_id') == post.author.user_id %}
        <div class="comment-actions post-actions">
          <details class="edit-card">
            <summary>Edit post</summary>
            <form action="{{ url_for('edit_forum_post', post_id=post.id) }}" method="post" class="inline-form">
              <label for="title-{{ post.id }}">Title</label>
              <input id="title-{{ post.id }}" name="title" type="text" value="{{ post.title }}" required>

              <label for="content-{{ post.id }}">Content</label>
              <textarea id="content-{{ post.id }}" name="content" rows="3" required>{{ post.content }}</textarea>

              <button type="submit" class="btn-secondary">Save changes</button>
            </form>
          </details>

          <form action="{{ url_for('delete_forum_post', post_id=post.id) }}" method="post" class="inline-form">
            <button type="submit" class="btn-danger">Delete post</button>
          </form>
        </div>
      {% endif %}

      <div class="comment-section">
        <h4>Comments ({{ post.comments|length }})</h4>

        <div class="comment-list">
          {% for comment in post.comments %}
            <div class="comment-card">
              <div class="comment-body">
                <div class="comment-header">
                  <a class="profile-link" href="{{ url_for('view_profile', user_id=comment.author.user_id) }}">
                    {{ comment.author.email }}
                  </a>
                  <span class="comment-time">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                </div>

                <div>{{ comment.content }}</div>

                {% if session.get('user_id') == comment.author.user_id %}
                  <div class="comment-actions">
                    <details class="inline-details">
                      <summary>Edit</summary>
                      <form action="{{ url_for('edit_forum_comment', comment_id=comment.id) }}" method="post" class="inline-form">
                        <label class="visually-hidden" for="comment-edit-{{ comment.id }}">Edit comment</label>
                        <textarea id="comment-edit-{{ comment.id }}" name="content" rows="2" required>{{ comment.content }}</textarea>
                        <button type="submit" class="btn-secondary">Save</button>
                      </form>
                    </details>

                    <form action="{{ url_for('delete_forum_comment', comment_id=comment.id) }}" method="post" class="inline-form">
                      <button type="submit" class="btn-danger" aria-label="Delete comment">Delete</button>
                    </form>
                  </div>
                {% endif %}
              </div>
            </div>
          {% else %}
            <p class="muted">No comments yet.</p>
          {% endfor %}
        </div>

        {% if session.get('user_id') %}
          <form action="{{ url_for('add_forum_comment', post_id=post.id) }}" method="post" class="comment-composer">
            <label for="comment-{{ post.id }}">Add a comment</label>
            <textarea id="comment-{{ post.id }}" name="content" rows="2" required></textarea>
            <button type="submit" class="btn-msg">Comment</button>
          </form>
        {% else %}
          <p class="muted-text">Sign in to join the conversation.</p>
        {% endif %}
      </div>
    </article>
  {% else %}
    <section class="post-card empty-card">
      <p class="muted-text">No posts yet. Be the first to start a discussion!</p>
    </section>
  {% endfor %}
</div>

{% endblock %}
