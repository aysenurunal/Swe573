{% extends "base.html" %}
{% block title %}{{ need.title }} ‚Äî The Hive{% endblock %}
{% block content %}

<div class="need-card">

  <!-- FLEX WRAPPER -->
  <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start;">

    <!-- LEFT SIDE -->
    <div style="flex:1; min-width:240px;">

      <h2 class="need-title">{{ need.title }}</h2>

      <p><strong>Hours:</strong> {{ need.hours }}</p>
      <p><strong>Location:</strong> {{ need.location }}</p>

      <p style="margin-top:12px;">
        {{ need.description }}
      </p>

      <p style="margin-top:18px;">
        <strong>Requested by:</strong>
        <a href="{{ url_for('my_profile', user_id=need.user_id) }}"
           style="color:#67e8f9;">
          {{ need.user.email.split("@")[0] }}
        </a>
      </p>

      <!-- FAVORITE BUTTON -->
      <form action="/toggle-need-favorite/{{ need.need_id }}" method="post" style="margin-top:10px;">
        <button class="heart-btn" style="background:none; border:none; cursor:pointer; font-size:26px; color:red;">
          {% if need.need_id in user_need_favorites %}
            ‚ô•
          {% else %}
            ‚ô°
          {% endif %}
        </button>
      </form>

      <!-- MESSAGE BUTTON / COMPLETED NOTICE -->
      {% if need.is_active %}
        <a href="{{ url_for('chat',
                      user_id=need.user_id,
                      listing_id=need.need_id,
                      type='need') }}"
           class="btn"
           style="padding:10px 18px;
                  font-size:0.95rem;
                  background:#22d3ee;
                  color:#0f172a;
                  border-radius:10px;
                  text-decoration:none;
                  display:inline-block;
                  margin-top:14px;">
          üí¨ Send Message
        </a>
      {% else %}
        <div style="margin-top:14px; padding:12px; background:#0b1727; border-radius:10px; color:#e2e8f0;">
          ‚ùå This post is completed. Chat and deals are no longer available.
        </div>
      {% endif %}

      <!-- OWNER-ONLY EDIT & DELETE BUTTONS -->
      {% if session.get('user_id') == need.user_id %}
        {% if not need.completed %}
        <div style="margin-top:12px; display:flex; gap:10px;">

          <!-- EDIT NEED BUTTON -->
          <a href="{{ url_for('edit_need', need_id=need.need_id) }}"
             style="
                padding:10px 16px;
                background:#60a5fa;
                color:white;
                border-radius:8px;
                font-weight:600;
                text-decoration:none;
                display:inline-block;
                margin-right:8px;">
            ‚úèÔ∏è Edit Need
          </a>

          <!-- DELETE NEED BUTTON -->
          <form action="{{ url_for('delete_need', need_id=need.need_id) }}"
                method="POST"
                style="display:inline;">
            <button type="submit"
                    style="
                      padding:10px 16px;
                      background:#ef4444;
                      color:white;
                      border-radius:8px;
                      font-weight:600;
                      border:none;
                      cursor:pointer;">
              üóëÔ∏è Delete
            </button>
          </form>

        </div>
        {% endif %}
      {% endif %}

    </div>

    <!-- RIGHT: IMAGE -->
    {% if need.image_filename %}
    <div style="flex:0 0 260px;">
      <img src="{{ url_for('static', filename='uploads/' ~ need.image_filename) }}"
           style="width:100%; border-radius:10px;">
    </div>
    {% endif %}

  </div>

  <hr style="margin: 24px 0; opacity:0.5;">

  <!-- MAP SECTION -->
  <h3 style="margin-top:15px;">Location on Map</h3>
  <div id="map" style="height:380px; border-radius:10px; margin-top:10px;"></div>
    <!-- RELATED LISTINGS -->
  <hr style="margin:24px 0; opacity:0.5;">
  <h3>Suggested matches</h3>
  {% if related_listings %}
    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:14px; margin-top:10px;">
      {% for suggestion in related_listings %}
        {% set item = suggestion.item %}
        <div style="padding:12px; border:1px solid #1f2937; border-radius:10px; background:#0b1727;">
          <div style="font-size:0.85rem; color:#94a3b8; margin-bottom:6px;">
            {{ 'Offer' if suggestion.type == 'offer' else 'Need' }}
            {% if item.location %} ‚Ä¢ {{ item.location }}{% endif %}
          </div>
          <h4 style="margin:0 0 8px 0;">
            <a href="{{ url_for('offer_detail', offer_id=item.offer_id) if suggestion.type == 'offer' else url_for('need_detail', need_id=item.need_id) }}"
               style="color:#e2e8f0; text-decoration:none;">
              {{ item.title }}
            </a>
          </h4>
          <p style="margin:0; color:#cbd5e1; font-size:0.95rem; line-height:1.4;">
            {{ item.description[:140] }}{% if item.description|length > 140 %}...{% endif %}
          </p>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p style="color:#94a3b8;">No related posts yet.</p>
  {% endif %}

</div>

<!-- LEAFLET MAP -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  // Serialize coordinates safely for JS (null when missing)
  const lat = {{ need.latitude|tojson }};
  const lon = {{ need.longitude|tojson }};

  if (lat !== null && lon !== null) {
    const map = L.map('map').setView([lat, lon], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    L.marker([lat, lon]).addTo(map)
      .bindPopup("{{ need.location }}")
      .openPopup();
  } else {
    const mapDiv = document.getElementById('map');
    mapDiv.innerHTML = "üìç Location not available.";
    mapDiv.style.textAlign = "center";
    mapDiv.style.padding = "40px";
  }
</script>

{% endblock %}

