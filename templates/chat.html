{% extends "base.html" %}
{% block title %}Chat ‚Äî The Hive{% endblock %}
{% block content %}

<h2 style="text-align:center; margin-bottom:10px;">
  üí¨ Chat with {{ other_user.email }}
</h2>

<!-- ---------------- LISTING SUMMARY CARD ---------------- -->
{% if listing_data %}
  {% if listing_data.type == "offer" %}
    {% set listing_url = url_for("offer_detail", offer_id=listing_data.id) %}
  {% else %}
    {% set listing_url = url_for("need_detail", need_id=listing_data.id) %}
  {% endif %}

  <a class="listing-summary-link" href="{{ listing_url }}" style="text-decoration:none; color:inherit;">
    <div class="listing-summary">
      <div class="listing-icon">
        {% if listing_data.type == "offer" %}
          üü° Offer
        {% else %}
          üîµ Need
        {% endif %}
      </div>

      <div class="listing-info">
        <div class="listing-title">
          {{ listing_data.title }}
        </div>

        <div class="listing-meta">
          {{ listing_data.hours }} hours ‚Äî {{ listing_data.location }}
        </div>
      </div>

      <div class="listing-thumb">
        üìÑ
      </div>
    </div>
  </a>
{% endif %}

<!-- ---------------- TIMELINE (Messages + Deals) ---------------- -->
<div class="timeline"
     data-last-timestamp="{{ last_message_ts }}"
     data-other-id="{{ other_user.user_id }}"
     data-listing-id="{{ session['active_listing_id'] }}"
     data-listing-type="{{ session['active_listing_type'] }}"
     data-current-user-id="{{ session['user_id'] }}"
     data-other-email="{{ other_user.email }}">
  {% for item in timeline %}

    {# ---------- MESAJ BALONU ---------- #}
    {% if item.type == "message" %}
      <div class="msg-bubble {% if item.sender_id == session['user_id'] %}me{% else %}them{% endif %}">
        <div class="msg-meta">{{ item.timestamp.strftime("%d.%m.%Y %H:%M") }}</div>
        {% if item.report %}
          <div class="msg-text">
            Report against
            <a class="report-link" href="{{ url_for('view_profile', user_id=item.report.user_id) }}">{{ item.report.email }}</a>
            (ID: {{ item.report.user_id }}): {{ item.report.reason }}
          </div>
        {% else %}
          <div class="msg-text">{{ item.content }}</div>
        {% endif %}
      </div>

    {# ---------- DEAL BALONU ---------- #}
    {% elif item.type == "deal" %}
      {% set deal = item.deal %}
      {% set is_me = (deal.starter_id == session['user_id']) %}

      {% set deal_class = "" %}
      {% if deal.status == "pending" %}
        {% set deal_class = "deal-pending" %}
      {% elif deal.status == "accepted" %}
        {% set deal_class = "deal-accepted" %}
      {% elif deal.status == "cancel_pending" %}
        {% set deal_class = "deal-cancel-pending" %}
      {% elif deal.status == "cancelled" %}
        {% set deal_class = "deal-cancelled" %}
      {% elif deal.status == "completed" %}
        {% set deal_class = "deal-completed" %}
      {% endif %}

      <div class="deal-bubble {{ deal_class }} {% if is_me %}me{% else %}them{% endif %}">
        <div class="deal-header">
          ü§ù Deal
          <span class="deal-status-tag">{{ deal.status|replace("_"," ")|title }}</span>
        </div>

        <div class="deal-body">
          <div><strong>Hours:</strong> {{ deal.hours }}</div>
          <div>
            <strong>Date:</strong>
            {% if deal.date %}
              {{ deal.date.strftime("%d.%m.%Y %H:%M") }}
            {% else %}
              Not set
            {% endif %}
          </div>
        </div>

        <div class="deal-actions">

          {% if deal.status == "pending" %}
            {% if session['user_id'] == deal.receiver_id %}
              <form action="/deal/accept/{{ deal.id }}" method="post" style="display:inline;">
                <button class="btn-small primary">Accept Deal</button>
              </form>
            {% else %}
              <span class="deal-note">Waiting for other user‚Ä¶</span>
            {% endif %}

          {% elif deal.status == "accepted" %}
            {% set i_confirmed = (session['user_id'] == deal.starter_id and deal.starter_confirm) or
                                   (session['user_id'] == deal.receiver_id and deal.receiver_confirm) %}

            {% if not i_confirmed %}
              <form action="/deal/complete/{{ deal.id }}" method="post" class="comment-complete-form">
                <label for="comment-{{ deal.id }}" class="comment-label">
                  Add a comment (max 250 chars) before completing:
                </label>
                <textarea name="comment"
                          id="comment-{{ deal.id }}"
                          maxlength="250"
                          required
                          placeholder="Share feedback for {{ other_user.email }}"></textarea>
                <button class="btn-small success">Confirm Completion</button>
              </form>
            {% else %}
              <span class="deal-note">Waiting for other user to confirm‚Ä¶</span>
            {% endif %}

            {% if not (deal.starter_confirm and deal.receiver_confirm) %}
              <form action="/deal/cancel_request/{{ deal.id }}" method="post" style="display:inline;">
                <button class="btn-small danger">Request Cancel</button>
              </form>
            {% endif %}

          {% elif deal.status == "cancel_pending" %}
            {% if (session['user_id'] == deal.starter_id and not deal.cancel_starter_confirm)
                  or (session['user_id'] == deal.receiver_id and not deal.cancel_receiver_confirm) %}
              <form action="/deal/cancel_confirm/{{ deal.id }}" method="post" style="display:inline;">
                <button class="btn-small danger">Confirm Cancel</button>
              </form>
            {% else %}
              <span class="deal-note">Waiting for other user‚Ä¶</span>
            {% endif %}

          {% elif deal.status == "cancelled" %}
            <span class="deal-note">‚ùå Deal cancelled.</span>

          {% elif deal.status == "completed" %}
            <span class="deal-note">üéâ Completed ‚Äî {{ deal.hours }} hours transferred.</span>
          {% endif %}
        </div>
      </div>

    {% endif %}
  {% endfor %}
</div>

<!-- ---------------- START DEAL FORM ---------------- -->
{% if listing_closed %}
  <div class="deal-note" style="text-align:center; margin:12px 0;">
    This post is completed. Messaging remains open, but new deals are disabled.
  </div>
{% else %}
  <form action="/deal/start/{{ other_user.user_id }}"
        method="post"
        class="deal-form">

    <input type="hidden" name="listing_id" value="{{ session['active_listing_id'] }}">
    <input type="hidden" name="listing_type" value="{{ session['active_listing_type'] }}">

    <input type="number"
           name="hours"
           min="1"
           required
           placeholder="Hours"
           class="deal-input">
    <input type="date"
           name="date"
           required
           class="deal-input">
    <input type="time"
           name="time"
           required
           class="deal-input">

    <button class="btn-msg">Start Deal</button>
  </form>
{% endif %}

<!-- ---------------- MESSAGE INPUT ---------------- -->
<form action="" method="post" class="chat-input" id="chat-form">
  <input type="text" name="message" id="chat-message" placeholder="Type a message..." required>
  <button type="submit">Send</button>
</form>
<div id="toast-container"></div>

<!-- ---------------- STYLES ---------------- -->
<style>
/* Listing summary card (top banner) */
.listing-summary-link {
  text-decoration: none;
  color: inherit;
  display: block;
}
.listing-summary {
  display: flex;
  align-items: center;
  gap: 14px;
  background: #1e1e1e;
  color: #fff;
  padding: 12px 16px;
  border-radius: 14px;
  margin-bottom: 20px;
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}

.listing-summary .listing-icon {
  font-size: 2rem;
}

.listing-summary .listing-info {
  flex: 1;
}

.listing-summary .listing-title {
  font-size: 1.15rem;
  font-weight: 600;
}

.listing-summary .listing-meta {
  font-size: 0.85rem;
  opacity: 0.8;
}

.listing-summary .listing-thumb {
  font-size: 1.8rem;
  opacity: 0.8;
}

/* Timeline container */
.timeline {
  max-height: 60vh;
  overflow-y: auto;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding-bottom: 80px;
  background: #ffffff;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  position: relative;
}

/* Message bubbles */
.msg-bubble,
.deal-bubble {
  padding: 10px 14px;
  border-radius: 18px;
  max-width: 80%;
  font-size: 0.95rem;
  line-height: 1.35;
}

.msg-bubble.me,
.deal-bubble.me {
  align-self: flex-end;
}

.msg-bubble.them,
.deal-bubble.them {
  align-self: flex-start;
}

.msg-bubble.me {
  background: #FFD84D;
  border-bottom-right-radius: 4px;
}

.msg-bubble.them {
  background: #E5E5EA;
  border-bottom-left-radius: 4px;
}

.msg-meta {
  font-size: 0.75rem;
  opacity: 0.8;
  margin-bottom: 4px;
}

.msg-text {
  font-size: 0.95rem;
  line-height: 1.4;
}
.report-link {
  color: #2563eb;
  font-weight: 600;
  text-decoration: none;
}

.report-link:hover,
.report-link:focus {
  text-decoration: underline;
}

/* Deal status colors */
.deal-pending { background:#fef3c7; border:1px solid #fde68a; }
.deal-accepted { background:#fde68a; border:1px solid #facc15; }
.deal-completed { background:#bbf7d0; border:1px solid #22c55e; }
.deal-cancel-pending { background:#fee2e2; border:1px solid #fecaca; }
.deal-cancelled { background:#fecaca; border:1px solid #ef4444; }

.deal-header {
  display:flex;
  justify-content:space-between;
  font-weight:600;
  margin-bottom:6px;
}

.deal-status-tag {
  font-size: 0.7rem;
  padding: 3px 8px;
  border-radius: 999px;
  background: rgba(17,24,39,0.08);
}

.deal-body {
  font-size: 0.9rem;
  margin-bottom: 8px;
}

.deal-actions {
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}

.deal-note {
  font-size:0.8rem;
  opacity:0.85;
}

.comment-complete-form {
  display: flex;
  flex-direction: column;
  gap: 6px;
  width: 100%;
}

.comment-complete-form textarea {
  width: 100%;
  min-height: 60px;
  resize: vertical;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 0.95rem;
}

.comment-label {
  font-size: 0.85rem;
  color: #374151;
}

/* Small buttons */
.btn-small {
  padding: 6px 10px;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  font-size: 0.8rem;
}

.btn-small.primary { background:#3b82f6; color:white; }
.btn-small.success { background:#22c55e; color:white; }
.btn-small.danger  { background:#ef4444; color:white; }

/* Start Deal form */
.deal-form {
  margin-top: 10px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.deal-input {
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.btn-msg {
  background:#FFD84D;
  border:none;
  padding:10px 18px;
  border-radius:10px;
  font-weight:600;
}

/* Chat input bottom */
.chat-input {
  position: fixed;
  bottom: 70px;
  left: 0; right: 0;
  padding: 10px;
  display: flex;
  gap: 10px;
  background: #ffffff;
  border-top:1px solid #e5e7eb;
}

.chat-input input {
  flex: 1;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid #ccc;
}

.chat-input button {
  background: #FFD84D;
  border: none;
  padding: 12px 18px;
  border-radius: 10px;
  font-weight: 600;
}

/* Toasts */
#toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 99;
}

.toast {
  background: #ffffff;
  color: #111827;
  padding: 12px 14px;
  border-radius: 10px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
  border: 1px solid #e5e7eb;
  min-width: 220px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const timelineEl = document.querySelector('.timeline');
  const chatForm = document.getElementById('chat-form');
  const messageInput = document.getElementById('chat-message');
  const toastContainer = document.getElementById('toast-container');

  if (!timelineEl) {
    return;
  }

  let lastTimestamp = timelineEl.dataset.lastTimestamp || '';
  const otherUserId   = timelineEl.dataset.otherId;
  const listingId     = timelineEl.dataset.listingId;
  const listingType   = timelineEl.dataset.listingType;
  const currentUserId = timelineEl.dataset.currentUserId;
  const otherUserEmail = timelineEl.dataset.otherEmail;

  const reportPattern = /Report against\s+(.+?)\s*\(ID:\s*(\d+)\)\s*:\s*(.+)/i;

  function parseReportLocally(content) {
    if (!content) return null;
    const match = content.match(reportPattern);
    if (!match) return null;
    return {
      email: match[1].trim(),
      user_id: parseInt(match[2], 10),
      reason: match[3].trim(),
    };
  }

  function formatTimestamp(ts) {
    const date = new Date(ts);
    return date.toLocaleString('tr-TR', {
      hour: '2-digit',
      minute: '2-digit',
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  }

  function scrollTimelineToBottom() {
    timelineEl.scrollTop = timelineEl.scrollHeight;
  }

  function addMessageBubble(msg) {
    const isMe = String(msg.sender_id) === String(currentUserId);

    const wrapper = document.createElement('div');
    wrapper.className = `msg-bubble ${isMe ? 'me' : 'them'}`;

    const meta = document.createElement('div');
    meta.className = 'msg-meta';
    meta.textContent = formatTimestamp(msg.timestamp);

    const text = document.createElement('div');
    text.className = 'msg-text';

    const parsedReport = msg.report || parseReportLocally(msg.content);

    if (parsedReport) {
      text.appendChild(document.createTextNode('Report against '));

      const reportLink = document.createElement('a');
      reportLink.href = `/profile/${parsedReport.user_id}`;
      reportLink.className = 'report-link';
      reportLink.textContent = parsedReport.email;
      text.appendChild(reportLink);

      text.appendChild(document.createTextNode(` (ID: ${parsedReport.user_id}): ${parsedReport.reason}`));
    } else {
      text.textContent = msg.content;
    }

    wrapper.appendChild(meta);
    wrapper.appendChild(text);
    timelineEl.appendChild(wrapper);
  }

  function showToast(text) {
    if (!toastContainer) return;

    const el = document.createElement('div');
    el.className = 'toast';
    el.textContent = text;
    toastContainer.appendChild(el);

    setTimeout(() => {
      el.style.opacity = '0';
      el.style.transition = 'opacity 0.4s ease';
      setTimeout(() => el.remove(), 400);
    }, 3500);
  }

  function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
  }

  function notifyNewMessage(msg) {
    const contentText = msg.report
      ? `Report against ${msg.report.email} (ID: ${msg.report.user_id}): ${msg.report.reason}`
      : msg.content;
    const text = `New message from ${otherUserEmail}: ${contentText}`;
    showToast(text);

    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification('New message', { body: contentText });
    }
  }

  async function sendMessage(text) {
    if (!text || !otherUserId || !listingId || !listingType) return;

    const params = new URLSearchParams({
      listing_id: listingId,
      listing_type: listingType
    });

    const res = await fetch(`/chat/${otherUserId}/messages?${params.toString()}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text })
    });

    if (res.ok) {
      const data = await res.json();
      if (data.message) {
        addMessageBubble(data.message);
        lastTimestamp = data.message.timestamp;
        scrollTimelineToBottom();
      }
    }
  }

  async function pollMessages() {
    if (!otherUserId || !listingId || !listingType) return;

    const params = new URLSearchParams({
      listing_id: listingId,
      listing_type: listingType
    });

    if (lastTimestamp) {
      params.append('after', lastTimestamp);
    }

    const res = await fetch(`/chat/${otherUserId}/messages?${params.toString()}`);
    if (!res.ok) return;

    const data = await res.json();
    if (!data.messages || !Array.isArray(data.messages)) return;

    data.messages.forEach(msg => {
      addMessageBubble(msg);
      if (String(msg.sender_id) !== String(currentUserId)) {
        notifyNewMessage(msg);
      }
      lastTimestamp = msg.timestamp;
    });

    if (data.messages.length) {
      scrollTimelineToBottom();
    }
  }

  // Initial scroll + notifications
  scrollTimelineToBottom();
  requestNotificationPermission();

  if (chatForm && messageInput) {
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;
      await sendMessage(text);
      messageInput.value = '';
      messageInput.focus();
    });
  }

  setInterval(pollMessages, 4000);
});
</script>

{% endblock %}
