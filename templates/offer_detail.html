{% extends "base.html" %}
{% block title %}{{ offer.title }} ‚Äî The Hive{% endblock %}
{% block content %}

<div class="offer-card">

  <div style="display:flex; flex-wrap:wrap; gap:24px;">

    <!-- LEFT SIDE (INFO) -->
    <div style="flex:1; min-width:260px;">

      <!-- Title -->
      <h2 class="offer-title">{{ offer.title }}</h2>

      <!-- Offer Badge -->
      <span class="type-badge offer">Offer</span>

      <!-- Meta Information -->
      <div class="card-meta">
        <strong>Hours:</strong> {{ offer.hours }}
        <br>
        <strong>Location:</strong> {{ offer.location }}
      </div>

      <!-- Favorite Button -->
      <form action="/toggle-favorite/{{ offer.offer_id }}" method="post" style="display:inline;">
        <button class="favorite-btn {% if offer.offer_id in user_favorites %}filled{% endif %}">
          {% if offer.offer_id in user_favorites %} ‚ô• {% else %} ‚ô° {% endif %}
        </button>
      </form>

      <!-- Description -->
      <p style="margin-top:12px; line-height:1.55;">
        {{ offer.description }}
      </p>

      <!-- Posted By -->
<p style="margin-top:18px;">
  <strong>Offered by:</strong>
  <a href="{{ url_for('view_profile', user_id=offer.user_id) }}"
     style="color:#ffd84d; text-decoration:none;">
    {{ offer.user.email.split('@')[0] }}
  </a>
</p>


      <!-- MESSAGE BUTTON / COMPLETED NOTICE -->
      {% if offer.is_active %}
        <a href="{{ url_for('chat',
                      user_id=offer.user_id,
                      listing_id=offer.offer_id,
                      type='offer') }}"
           class="btn"
           style="padding:10px 18px;
                  font-size:0.95rem;
                  background:#ffd84d;
                  color:#111;
                  border-radius:10px;
                  text-decoration:none;
                  display:inline-block;
                  margin-top:14px;">
          üí¨ Send Message
        </a>
      {% else %}
        <div style="margin-top:14px; padding:12px; background:#1f2937; border-radius:10px; color:#f9fafb;">
          ‚ùå This post is completed. Chat and deals are no longer available.
        </div>
      {% endif %}

      <!-- OWNER-ONLY EDIT & DELETE BUTTONS -->
      {% if session.get('user_id') == offer.user_id %}
        {% if not offer.completed %}
        <div style="margin-top:14px; display:flex; gap:12px;">

          <!-- EDIT BUTTON -->
<a href="{{ url_for('edit_offer', offer_id=offer.offer_id) }}"
   style="
      padding:10px 16px;
      background:#60a5fa;
      color:white;
      border-radius:8px;
      font-weight:600;
      text-decoration:none;
      display:inline-block;
      margin-right:8px;
   ">
  ‚úèÔ∏è Edit Offer
</a>

<!-- DELETE BUTTON -->
<form action="{{ url_for('delete_offer', offer_id=offer.offer_id) }}"
      method="POST"
      style="display:inline;">
  <button type="submit"
          style="
            padding:10px 16px;
            background:#ef4444;
            color:white;
            border-radius:8px;
            font-weight:600;
            border:none;
            cursor:pointer;
          ">
    üóëÔ∏è Delete
  </button>
</form>


        </div>
        {% endif %}
      {% endif %}

    </div>

    <!-- RIGHT SIDE (IMAGE) -->
    {% if offer.image_filename %}
      <div style="flex:0 0 280px;">
        <img src="{{ url_for('static', filename='uploads/' ~ offer.image_filename) }}"
             style="width:100%; border-radius:12px;">
      </div>
    {% endif %}

  </div>

  <!-- DIVIDER -->
  <hr style="margin:26px 0; opacity:0.5;">

  <!-- MAP SECTION -->
  <h3>Location on Map</h3>
  <div id="map" style="height:380px; border-radius:12px; margin-top:12px;"></div>

</div>

<!-- Leaflet Scripts -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  // Serialize coordinates safely for JS (null when missing)
  const lat = {{ offer.latitude|tojson }};
  const lon = {{ offer.longitude|tojson }};

  if (lat !== null && lon !== null) {
    const map = L.map('map').setView([lat, lon], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    L.marker([lat, lon]).addTo(map)
      .bindPopup("{{ offer.location }}")
      .openPopup();
  } else {
    const mapDiv = document.getElementById('map');
    mapDiv.innerHTML = "üìç Location not available.";
    mapDiv.style.textAlign = "center";
    mapDiv.style.padding = "40px";
  }
</script>

{% endblock %}
